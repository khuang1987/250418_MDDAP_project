# MES超期判断逻辑修复报告

## 修复目标
修复MES ETL过程中的超期判断逻辑，使其正确处理换型时间，提高超期判断的准确性。

## 修复前的问题

### 1. 固定换批时间
- **问题**: 所有工序统一使用0.5小时换批时间
- **影响**: 换型工序的超期判断不准确
- **缺失**: 未考虑标准换型时间的差异

### 2. 业务逻辑不一致
- **问题**: 超期判断与ST计算中的换型时间处理不一致
- **影响**: 数据分析结果偏差

## 修复方案

### 1. 换型时间处理逻辑
```python
# 修复前（固定0.5小时）
tolerance_and_changeover = tolerance_h + 0.5

# 修复后（动态换型时间）
changeover_time = 0.5  # 默认换批时间
if row.get("Setup") == "Yes" and pd.notna(row.get("Setup Time (h)")):
    changeover_time = row.get("Setup Time (h)", 0.5) or 0.5  # 使用标准换型时间

tolerance_and_changeover = tolerance_h + changeover_time
```

### 2. 判断规则
- **正常换批**: 使用0.5小时固定时间
- **换型情况**: Setup="Yes"时，使用标准换型时间（Setup Time字段）
- **容差时间**: 统一8小时（所有工序）

## 修改的文件

### 1. 主要代码文件
- `etl_dataclean_mes_batch_report.py`
  - 修改函数: `calculate_completion_status()` (第1350-1356行)
  - 更新函数注释，说明换型时间处理规则

### 2. 测试验证文件
- `test_overdue_logic_fix.py`
  - 验证新旧逻辑差异
  - 测试不同换型时间场景

## 测试验证结果

### 测试案例
| 案例 | PT(小时) | ST(小时) | Setup | 换型时间 | 旧逻辑结果 | 新逻辑结果 | 差异 |
|------|----------|----------|-------|----------|------------|------------|------|
| 正常换批 | 24.0 | 19.2 | No | - | OnTime | OnTime | 无 |
| 正常换批超期 | 28.8 | 19.2 | No | - | Overdue | Overdue | 无 |
| 换型1小时 | 26.4 | 19.2 | Yes | 1.0 | OnTime | OnTime | 无 |
| 换型2小时 | 27.6 | 19.2 | Yes | 2.0 | OnTime | OnTime | 无 |
| **换型0.1小时** | **27.36** | **19.2** | **Yes** | **0.1** | **OnTime** | **Overdue** | **✅** |

### 关键发现
- **案例5**: PT=27.36小时，换型时间0.1小时
  - 旧逻辑: 27.36 ≤ 27.7 → OnTime
  - 新逻辑: 27.36 > 27.3 → Overdue
  - **结果**: 成功展示换型时间对超期判断的影响

## 业务影响分析

### 1. 积极影响
- **准确性提升**: 换型工序的超期判断更符合实际
- **逻辑一致**: 与ST计算的换型时间处理保持一致
- **数据质量**: 提高整体数据分析的可靠性

### 2. 预期变化
- **长换型时间工序**: 超期率可能下降（更宽松的判断标准）
- **短换型时间工序**: 超期率可能上升（更严格的判断标准）
- **正常换批工序**: 无影响

### 3. 业务价值
- 更真实的反映生产效率
- 考虑不同工序的换型复杂度
- 为生产优化提供准确数据支撑

## 技术细节

### 1. 超期判断公式
```
如果 (PT - 非工作日时间) > (ST + 8小时容差 + 换批/换型时间)
    则状态 = "Overdue"
否则
    则状态 = "OnTime"
```

### 2. 换型时间规则
- **默认值**: 0.5小时（正常换批）
- **换型情况**: 当Setup="Yes"且Setup Time不为空时，使用Setup Time值
- **回退机制**: 如果Setup Time为空，回退到0.5小时

### 3. 数据字段依赖
- `Setup`: 判断是否为换型工序
- `Setup Time (h)`: 标准换型时间（小时）
- `PT(d)`: 实际加工时间（天）
- `ST(d)`: 理论加工时间（天）
- `Tolerance(h)`: 容差时间（默认8小时）

## 部署建议

### 1. 验证步骤
1. 运行完整ETL流程验证修复效果
2. 对比修复前后的超期率变化
3. 检查换型工序的超期分布情况
4. 确认业务数据的合理性

### 2. 监控指标
- 整体超期率变化
- 换型工序超期率变化
- 数据质量指标
- 业务用户反馈

### 3. 回滚计划
如发现问题，可以回滚到修复前的代码：
```python
# 回滚到固定换批时间
tolerance_and_changeover = tolerance_h + 0.5
```

## 总结

✅ **修复完成**: MES超期判断逻辑已成功修复，支持换型时间处理  
✅ **逻辑正确**: 正常换批0.5小时，换型使用标准换型时间  
✅ **测试通过**: 所有测试案例验证通过，成功展示逻辑差异  
✅ **业务价值**: 提高超期判断准确性，为生产优化提供可靠数据  

**下一步**: 建议运行完整ETL验证修复效果，并监控业务指标变化。
