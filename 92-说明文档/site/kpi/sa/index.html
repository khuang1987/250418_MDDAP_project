<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Medtronic CZ Ops Team" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>SA - 计划达成率 - CZ Ops 数字化数据平台 - 电子说明书</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../stylesheets/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "SA - \u8ba1\u5212\u8fbe\u6210\u7387";
        var mkdocs_page_input_path = "kpi\\sa.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> CZ Ops 数字化数据平台 - 电子说明书
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">首页</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">KPI 核心指标</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../">KPI 指标体系</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >供应链 KPI</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../supply-chain/">供应链 KPI 总览</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">SA - 计划达成率</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#sa">什么是 SA 指标？</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#_1">官方定义</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_2">核心概念</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#_3">计算公式</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#_4">判断标准</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_5">数据体系</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#_6">三大数据源</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_7">📋 详细内容导航</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_8">关键字段速查</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_9">重要说明</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_10">相关资源</a>
    </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../inventory-turns/">IT - 库存周转率</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../otd/">OTD - 准时交付率</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../backlog/">BL - 积压订单</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../total-inventory/">TI - 总库存</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../supplier-performance/">SP - 供应商绩效</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../procurement-savings/">PS - 采购成本节约</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >生产 KPI</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../production/">生产 KPI 总览</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../oee/">OEE - 设备综合效率</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../pcp/">PCP - 生产计划完成率</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../cur/">CUR - 产能利用率</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../cycle-time/">CT - 生产周期时间</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../mfg-variances/">MV - 制造差异</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../period-expense/">PE - 期间费用</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../labor-efficiency/">LE - 人工效率</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >质量 KPI</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../quality/">质量 KPI 总览</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../fpy/">FPY - 一次合格率</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ncr/">NCR - 不合格品率</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../capa/">CAPA - CAPA 完成率</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ccr/">CCR - 客户投诉率</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../rework/">RW - 返工率</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../process-capability/">PCI - 过程能力指数</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >持续改进 KPI</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../ci/">持续改进 KPI 总览</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ci-project/">CI-Project - 改善项目完成率</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../cost-savings/">CS - 成本节约</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../employee-engagement/">EE - 员工参与度</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../project-cycle-time/">PCT - 项目周期时间</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../roi/">ROI - 投资回报率</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../innovation-proposals/">IP - 创新提案数</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../standardization-rate/">SR - 标准化率</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">报表说明</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../reports/">报表总览</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../reports/completed/">已完成报表</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../reports/guides/">报表使用指南</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../reports/maintenance/">报表维护说明</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">技术实现</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" >ETL 流程</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../etl/">ETL 概述</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../etl/etl-process/">ETL 流程说明</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../etl/etl-sa/">SA 数据清洗</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../etl/etl-sfc/">SFC 数据清洗</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../etl/standard-time/">标准时间处理</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../etl/configuration/">配置说明</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Power Query 代码</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../pq/">PQ 概述</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../pq/mes-records/">MES 报工记录</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../pq/sfc-records/">SFC 报工记录</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../pq/standard-time/">标准时间查询</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../pq/incremental-refresh/">增量刷新方案</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">项目记录</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" >项目总览与进展</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../project/progress/">项目总览</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../project/progress/progress/">详细进展文档</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >DMAIC 阶段记录</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" >定义阶段（Define）</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../project/01_Define_%E5%AE%9A%E4%B9%89%E9%98%B6%E6%AE%B5/">定义阶段概述</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../project/01_Define_%E5%AE%9A%E4%B9%89%E9%98%B6%E6%AE%B5/01_ProjectDefinition_%E9%A1%B9%E7%9B%AE%E5%AE%9A%E4%B9%89/">项目定义文档</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >测量阶段（Measure）</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../project/02_Measure_%E6%B5%8B%E9%87%8F%E9%98%B6%E6%AE%B5/">测量阶段概述</a>
                </li>
                <li class="toctree-l3"><a class="" href="../../project/02_Measure_测量阶段/01_DataCollectionPlan_数据收集计划.md">数据收集计划</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../project/02_Measure_%E6%B5%8B%E9%87%8F%E9%98%B6%E6%AE%B5/02_KpiSpecification_KPI%E8%AF%A6%E7%BB%86%E8%AF%B4%E6%98%8E/">KPI详细说明</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../project/02_Measure_%E6%B5%8B%E9%87%8F%E9%98%B6%E6%AE%B5/03_KpiMindmap_KPI%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE/">KPI思维导图</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../project/02_Measure_%E6%B5%8B%E9%87%8F%E9%98%B6%E6%AE%B5/04_MeasurePhase_%E6%B5%8B%E9%87%8F%E9%98%B6%E6%AE%B5/">测量阶段文档</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../project/03_Analyze_%E5%88%86%E6%9E%90%E9%98%B6%E6%AE%B5/">分析阶段（Analyze）</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >改进阶段（Improve）</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../project/04_Improve_%E6%94%B9%E8%BF%9B%E9%98%B6%E6%AE%B5/">改进阶段概述</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../project/04_Improve_%E6%94%B9%E8%BF%9B%E9%98%B6%E6%AE%B5/01_ImprovementPlan_%E6%94%B9%E8%BF%9B%E6%96%B9%E6%A1%88/">改进方案</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >控制阶段（Control）</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../project/05_Control_%E6%8E%A7%E5%88%B6%E9%98%B6%E6%AE%B5/">控制阶段概述</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../project/05_Control_%E6%8E%A7%E5%88%B6%E9%98%B6%E6%AE%B5/01_ControlPlan_%E6%8E%A7%E5%88%B6%E8%AE%A1%E5%88%92/">控制计划</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >会议纪要</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../project/meetings/">会议纪要概述</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../project/meetings/meetings/">详细会议记录</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">参考资料</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../reference/naming-convention/">文件命名规范</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../reference/dictionary/">字典表说明</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../changelog/">更新日志</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">CZ Ops 数字化数据平台 - 电子说明书</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">KPI 核心指标</li>
          <li class="breadcrumb-item">供应链 KPI</li>
      <li class="breadcrumb-item active">SA - 计划达成率</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="sa-">SA - 计划达成率<a class="headerlink" href="#sa-" title="Permanent link">&para;</a></h1>
<p><strong>Schedule Adherence（SA）</strong> 是供应链 KPI 体系中的核心指标，用于衡量生产是否按照既定生产计划执行。</p>
<div class="admonition info">
<p class="admonition-title">指标归属</p>
<p>SA 指标属于 <strong><a href="../supply-chain/">供应链部门 KPI</a></strong> 体系，是评估生产计划执行情况的关键指标。</p>
</div>
<hr />
<h2 id="sa">什么是 SA 指标？<a class="headerlink" href="#sa" title="Permanent link">&para;</a></h2>
<h3 id="_1">官方定义<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<div class="admonition quote">
<p class="admonition-title">英文原文</p>
<p>Schedule Adherence is a metric revealing whether or not production is adhering to the scheduled operating plan. The metric is defined as a percentage of output over demand. Schedule Adherence plays an important role in production performance.</p>
</div>
<div class="admonition info">
<p class="admonition-title">中文解读</p>
<p>Schedule Adherence（计划达成率）是衡量生产是否按照既定生产计划执行的重要指标。该指标通常以"产出/需求"的百分比来表示，反映了生产实际完成情况与计划之间的吻合程度。计划达成率在生产绩效中起着重要作用。</p>
</div>
<hr />
<h2 id="_2">核心概念<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="_3">计算公式<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>SA 指标的基本计算公式：</p>
<div class="arithmatex">\[
SA(\%) = \frac{\text{按期完成的批次数}}{\text{总批次数}} \times 100\%
\]</div>
<h3 id="_4">判断标准<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>单个批次的 SA 状态判断：</p>
<ul>
<li><strong>按期（OnTime）</strong>：实际完工时间 ≤ 应完工时间</li>
<li><strong>逾期（Overdue）</strong>：实际完工时间 &gt; 应完工时间</li>
</ul>
<p>其中：
- <strong>实际完工时间</strong>：TrackOutTime（工序报工时间）
- <strong>应完工时间</strong>：DueTime = TrackInTime + ST(d) + Weekend(d)</p>
<hr />
<h2 id="_5">数据体系<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<h3 id="_6">三大数据源<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<pre class="mermaid"><code>graph LR
    A[SFC 原始数据] --&gt; D[SFC 处理后数据]
    B[MES 原始数据] --&gt; E[MES 处理后数据]
    C[标准时间表] --&gt; F[SAP Routing]
    D --&gt; G[Power BI]
    E --&gt; G
    F --&gt; G</code></pre>
<ol>
<li><strong>SFC 批次报工记录</strong>：提供 Check In 时间</li>
<li><strong>MES 批次报工记录</strong>：核心生产数据</li>
<li><strong>产品标准时间</strong>：计划参数（标准时间、OEE 等）</li>
</ol>
<hr />
<h2 id="_7">📋 详细内容导航<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<details class="abstract">
<summary><strong>🧮 计算方法与定义</strong></summary>

### 1. SA 指标定义

#### 1.1 官方定义

!!! quote "Schedule Adherence Definition"
    Schedule Adherence is a metric revealing whether or not production is adhering to the scheduled operating plan. The metric is defined as a percentage of output over demand. Schedule Adherence plays an important role in production performance.

#### 1.2 中文解读

Schedule Adherence（计划达成率）是衡量生产是否按照既定生产计划执行的重要指标。该指标通常以"产出/需求"的百分比来表示，反映了生产实际完成情况与计划之间的吻合程度。

---

### 2. 核心计算公式

#### 2.1 SA 达成率计算

\[
SA(\%) = \frac{\text{按期完成的批次数}}{\text{总批次数}} \times 100\%
\]

其中：
- **按期完成批次**：CompletionStatus = "OnTime" 的批次
- **总批次数**：统计时间范围内的所有批次

#### 2.2 单批次 SA 状态判断

<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>IF TrackOutTime ≤ DueTime THEN
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    CompletionStatus = &quot;OnTime&quot;
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    SA状态 = 1
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>ELSE
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    CompletionStatus = &quot;Overdue&quot;
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    SA状态 = 0
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>END IF
</span></code></pre></div>

---

### 3. 核心计算逻辑

#### 3.1 Lead Time (LT) 计算

**Lead Time** 表示从批次进入工序到完成报工的总时间。

##### 3.1.1 MES 数据 - LT 计算

**0010 工序**（首道工序）：
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>开始时间选择优先级：
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>1. Checkin_SFC（从 SFC 数据合并）
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>2. EnterStepTime（进入工序时间）
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>3. TrackInTime（工序投入时间）
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>LT(d) = (TrackOutTime - 开始时间) / 24 小时
</span></code></pre></div>

**非 0010 工序**：
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>LT(d) = (TrackOutTime - EnterStepTime) / 24 小时
</span></code></pre></div>

##### 3.1.2 SFC 数据 - LT 计算

**0010 工序**：
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>LT(d) = (TrackOutTime - Checkin_SFC) / 24 小时
</span></code></pre></div>

**非 0010 工序**：
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>LT(d) = (TrackOutTime - EnterStepTime) / 24 小时
</span></code></pre></div>

!!! note "说明"
    - LT 计算不扣除周末
    - 单位：天，保留 2 位小数
    - 空值处理：如果起始时间为空，返回 null

---

#### 3.2 Process Time (PT) 计算

**Process Time** 表示批次实际加工时间。

##### 3.2.1 MES 数据 - PT 计算

<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># 确定开始时间</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="k">if</span> <span class="n">Checkin_SFC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    <span class="n">开始时间</span> <span class="o">=</span> <span class="n">Checkin_SFC</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>    <span class="n">开始时间</span> <span class="o">=</span> <span class="n">TrackInTime</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="c1"># 计算 PT</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="n">PT</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">TrackOutTime</span> <span class="o">-</span> <span class="n">开始时间</span><span class="p">)</span> <span class="o">/</span> <span class="mi">24</span>  <span class="c1"># 转换为天</span>
</span></code></pre></div>

##### 3.2.2 SFC 数据 - PT 计算

<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">PT</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">TrackOutTime</span> <span class="o">-</span> <span class="n">Checkin_SFC</span><span class="p">)</span> <span class="o">/</span> <span class="mi">24</span>  <span class="c1"># 转换为天</span>
</span></code></pre></div>

!!! note "说明"
    - PT 计算不扣除周末
    - 单位：天，保留 2 位小数
    - 空值处理：如果起始时间为空，返回 null

---

#### 3.3 标准时间 ST(d) 计算

**标准时间** 表示理论上完成该批次所需的时间。

##### 3.3.1 MES 数据 - ST 计算

<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># 1. 确定单件时间（优先机器时间）</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="k">if</span> <span class="n">EH_machine</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">EH_machine</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    <span class="n">单件时间_秒</span> <span class="o">=</span> <span class="n">EH_machine</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>    <span class="n">单件时间_秒</span> <span class="o">=</span> <span class="n">EH_labor</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="n">单件时间_小时</span> <span class="o">=</span> <span class="n">单件时间_秒</span> <span class="o">/</span> <span class="mi">3600</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="c1"># 2. 确定 OEE（默认 77%）</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="k">if</span> <span class="n">OEE</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">OEE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>    <span class="n">OEE</span> <span class="o">=</span> <span class="mf">0.77</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="c1"># 3. 确定调试时间</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="k">if</span> <span class="n">Setup</span> <span class="o">==</span> <span class="s2">&quot;Yes&quot;</span><span class="p">:</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>    <span class="n">调试时间_小时</span> <span class="o">=</span> <span class="n">Setup_Time_h</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>    <span class="n">调试时间_小时</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="c1"># 4. 计算标准时间</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="n">ST_小时</span> <span class="o">=</span> <span class="n">调试时间_小时</span> <span class="o">+</span> <span class="p">(</span><span class="n">StepInQuantity</span> <span class="err">×</span> <span class="n">单件时间_小时</span> <span class="o">/</span> <span class="n">OEE</span><span class="p">)</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="n">ST_天</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">ST_小时</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></code></pre></div>

##### 3.3.2 SFC 数据 - ST 计算

<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># 1-3 步骤与 MES 相同</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="c1"># 4. 计算数量（合格品 + 报废品）</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="n">数量</span> <span class="o">=</span> <span class="n">TrackOutQuantity</span> <span class="o">+</span> <span class="n">ScrapQuantity</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="c1"># 5. 计算标准时间（包含换批时间）</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="n">ST_小时</span> <span class="o">=</span> <span class="n">调试时间_小时</span> <span class="o">+</span> <span class="p">(</span><span class="n">数量</span> <span class="err">×</span> <span class="n">单件时间_小时</span> <span class="o">/</span> <span class="n">OEE</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="n">ST_天</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">ST_小时</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></code></pre></div>

!!! tip "关键参数说明"
    - **EH_machine(s)**：单件机器加工时间（秒）
    - **EH_labor(s)**：单件人工操作时间（秒）
    - **OEE**：设备综合效率（0-1 之间，默认 0.77）
    - **Setup Time (h)**：调试时间（小时）
    - **换批时间**：SFC 数据固定增加 0.5 小时

---

#### 3.4 应完工时间 (DueTime) 计算

**应完工时间** 基于工作日日历表计算，自动跳过非工作日（周末和法定节假日）。

##### 3.4.1 核心算法

<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_due_time</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">plan_hours</span><span class="p">,</span> <span class="n">calendar_df</span><span class="p">):</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="sd">    按工作日逐天累加工作时间，跳过非工作日</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="sd">    参数:</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="sd">        start_time: 开始时间（TrackInTime 或 Checkin_SFC）</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="sd">        plan_hours: 计划小时数（标准时间 + 换批时间）</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="sd">        calendar_df: 工作日日历表</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="sd">    返回:</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="sd">        due_time: 应完工时间</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="sd">        weekend_days: 扣除的非工作日天数</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>    <span class="n">current_time</span> <span class="o">=</span> <span class="n">start_time</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>    <span class="n">remaining_hours</span> <span class="o">=</span> <span class="n">plan_hours</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>    <span class="n">weekend_hours</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>    <span class="k">while</span> <span class="n">remaining_hours</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>        <span class="n">current_date</span> <span class="o">=</span> <span class="n">current_time</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>        <span class="c1"># 查询日历表判断是否为工作日</span>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>        <span class="n">is_workday</span> <span class="o">=</span> <span class="n">calendar_df</span><span class="p">[</span>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>            <span class="n">calendar_df</span><span class="p">[</span><span class="s1">&#39;日期&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">current_date</span>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>        <span class="p">][</span><span class="s1">&#39;是否工作日&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>        <span class="k">if</span> <span class="n">is_workday</span><span class="p">:</span>
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>            <span class="c1"># 工作日：减少剩余工时（24小时连续工作）</span>
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>            <span class="n">daily_hours</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">remaining_hours</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>  <span class="c1"># 每天24小时</span>
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>            <span class="n">remaining_hours</span> <span class="o">-=</span> <span class="n">daily_hours</span>
</span><span id="__span-9-30"><a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-9-31"><a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a>            <span class="c1"># 非工作日：计入 Weekend</span>
</span><span id="__span-9-32"><a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>            <span class="n">weekend_hours</span> <span class="o">+=</span> <span class="mi">24</span>
</span><span id="__span-9-33"><a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>
</span><span id="__span-9-34"><a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a>        <span class="c1"># 推进到下一天</span>
</span><span id="__span-9-35"><a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a>        <span class="n">current_time</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-9-36"><a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a>
</span><span id="__span-9-37"><a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a>    <span class="n">due_time</span> <span class="o">=</span> <span class="n">current_time</span>
</span><span id="__span-9-38"><a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a>    <span class="n">weekend_days</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">weekend_hours</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="__span-9-39"><a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a>
</span><span id="__span-9-40"><a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a>    <span class="k">return</span> <span class="n">due_time</span><span class="p">,</span> <span class="n">weekend_days</span>
</span></code></pre></div>

!!! warning "重要说明"
    - 应完工时间计算**会跳过非工作日**（周末和法定节假日）
    - 工作日判断基于 `日历工作日表.csv`
    - Weekend(d) 表示从开始到应完工时间之间的非工作日天数
    - 换批时间固定为 0.5 小时

---

#### 3.5 完工状态 (CompletionStatus) 判断

<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">if</span> <span class="n">TrackOutTime</span> <span class="o">&lt;=</span> <span class="n">DueTime</span><span class="p">:</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>    <span class="n">CompletionStatus</span> <span class="o">=</span> <span class="s2">&quot;OnTime&quot;</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>    <span class="n">SA状态</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>    <span class="n">CompletionStatus</span> <span class="o">=</span> <span class="s2">&quot;Overdue&quot;</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>    <span class="n">SA状态</span> <span class="o">=</span> <span class="mi">0</span>
</span></code></pre></div>

!!! tip "容差说明"
    - 标准计算不包含容差
    - 如需容差分析，可在 Power BI 中添加 8 小时容差：
      <div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>CompletionStatus_WithTolerance = 
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>IF(TrackOutTime &lt;= DueTime + 8/24, &quot;OnTime&quot;, &quot;Overdue&quot;)
</span></code></pre></div>

---

### 4. 换批 (Setup) 判断逻辑

#### 4.1 MES 数据换批判断

<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># 按 machine 和 CFN 分组，按 TrackOutTime 排序</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="c1"># 计算 PreviousBatchEndTime（同一机台上一批次的结束时间）</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="k">if</span> <span class="n">PreviousBatchEndTime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>    <span class="c1"># 第一批次，需要换批</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>    <span class="n">Setup</span> <span class="o">=</span> <span class="s2">&quot;Yes&quot;</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>    <span class="c1"># 检查产品号是否相同</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>    <span class="k">if</span> <span class="n">CFN</span> <span class="o">==</span> <span class="n">上一批次的CFN</span><span class="p">:</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>        <span class="n">Setup</span> <span class="o">=</span> <span class="s2">&quot;No&quot;</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>        <span class="n">Setup</span> <span class="o">=</span> <span class="s2">&quot;Yes&quot;</span>
</span></code></pre></div>

!!! note "换批说明"
    - 换批判断基于同一机台的连续批次
    - 如果产品号（CFN）发生变化，判断为需要换批
    - 换批会增加调试时间（Setup Time）

</details>

<details class="abstract">
<summary><strong>📊 字段说明</strong></summary>

### 1. 基础标识字段

| 字段名 | 英文名 | 数据类型 | 说明 | 示例 | 数据来源 |
|--------|--------|----------|------|------|----------|
| 批次号 | BatchNumber | Text | 生产批次唯一标识 | K24A2066 | MES/SFC |
| 产品号 | CFN | Text | 产品编码 | 858-957-11 | MES/SFC |
| 生产订单 | ProductionOrder | Int64 | 生产订单号（整数格式） | 228032737 | MES |
| 工序号 | Operation | Text | 4位工序代码，自动补零 | 0010, 0020 | MES/SFC |
| 工序名称 | Operation description | Text | 标准化后的工序名称 | 数控铣, 数控车 | MES/SFC |
| 工艺路线 | Group | Text | 产品工艺路线分组（提取数字部分） | CZM 50210119 | MES |
| 机台号 | machine | Int64/Text | 生产设备编号（MES为文本，SFC为整数） | M001, 1 | MES/SFC |
| 生产区域 | ProductionArea | Text | 生产区域名称 | CZM 线切割 WEDM | MES |
| 产品类型 | ProductType | Text | 产品类型分类 | CZM | SFC |
| 报工人 | TrackOut_User | Text | 报工人员姓名 | 张三 | SFC |
| Check In人员 | CheckIn_User | Text | Check In人员姓名 | 李四 | SFC |
| VSM | VSM | Text | 生产主管 | Wang Li | MES |
| ERP代码 | ERPCode | Text | ERP系统代码 | 12345 | MES |
| 产品描述 | Product_Description | Text | 产品描述信息 | Implant Device | MES |

---

### 2. 时间相关字段

| 字段名 | 英文名 | 数据类型 | 说明 | 示例 | 数据来源 |
|--------|--------|----------|------|------|----------|
| 进入工序时间 | EnterStepTime | DateTime | 批次进入工序的时间 | 2025-01-15 08:30:00 | MES/SFC |
| 工序投入时间 | TrackInTime | DateTime | 工序开始加工的时间 | 2025-01-15 08:35:00 | MES |
| SFC Check In时间 | Checkin_SFC | DateTime | SFC系统的Check In时间 | 2025-01-15 08:25:00 | SFC（合并到MES） |
| 工序报工时间 | TrackOutTime | DateTime | 工序完成报工的时间 | 2025-01-15 16:30:00 | MES/SFC |
| 报工日期 | TrackOutDate | Date | 工序报工时间的日期部分 | 2025-01-15 | MES（计算得出） |
| 应完工时间 | DueTime | DateTime | 基于计划计算的应完工时间（考虑周末） | 2025-01-15 17:00:00 | 计算得出 |
| 上批结束时间 | PreviousBatchEndTime | DateTime | 同一机台上一批次的结束时间（空值保存为null） | 2025-01-15 06:00:00 | MES/SFC（计算得出） |

#### 时间字段说明

!!! info "时间字段详细说明"
    - **EnterStepTime**：批次首次进入该工序的时间
    - **TrackInTime**：工序正式开始加工的时间（可能晚于进入时间）
    - **Checkin_SFC**：SFC 系统记录的 Check In 时间（优先用于 PT 计算）
    - **TrackOutTime**：工序完成并报工的时间
    - **DueTime**：基于标准时间和工作日日历计算的应完工时间

!!! warning "时间格式"
    所有时间字段格式为：`YYYY-MM-DD HH:MM:SS`（24小时制）

---

### 3. 数量相关字段

| 字段名 | 英文名 | 数据类型 | 说明 | 示例 | 数据来源 |
|--------|--------|----------|------|------|----------|
| 工序投入数量 | StepInQuantity | Int64 | 进入工序的物料数量 | 300 | MES |
| 工序产出数量 | TrackOutQuantity | Int64 | 工序完成后的产出数量 | 106 | MES/SFC |
| 报废数量 | ScrapQuantity | Int64 | 工序报废的物料数量 | 0 | SFC |

#### 数量字段说明

!!! tip "数量计算规则"
    - **MES 数据 ST 计算**：使用 `StepInQuantity`（投入数量）
    - **SFC 数据 ST 计算**：使用 `TrackOutQuantity + ScrapQuantity`（产出 + 报废）

---

### 4. 标准时间参数字段

| 字段名 | 英文名 | 数据类型 | 说明 | 示例 | 数据来源 |
|--------|--------|----------|------|------|----------|
| 单件机器时间 | EH_machine(s) | Number | 单件机器加工时间（秒） | 3780 | 标准时间表（Machine/Quantity） |
| 单件人工时间 | EH_labor(s) | Number | 单件人工操作时间（秒） | 1800 | 标准时间表（Labor/Quantity） |
| 设备综合效率 | OEE | Number | 设备综合效率（0-1之间；空值或0按0.77处理） | 0.80 | 标准时间表 |
| 调试时间 | Setup Time (h) | Number | 设备调试时间（小时） | 0.50 | 标准时间表 |
| 是否调试 | Setup | Text | 是否需要进行调试（Yes/No） | Yes | MES（计算得出） |

#### 标准时间参数说明

!!! info "参数来源"
    这些参数来自 **SAP Routing 标准时间表**，由以下文件合并生成：

    - `1303 Routing.csv`：提供 Machine、Labor 时间（秒）
    - `1303机加工清单.csv`：提供 OEE、Setup Time

!!! note "OEE 默认值"
    如果 OEE 为空或为 0，系统自动使用默认值 **0.77**（77%）

---

### 5. 计算字段

| 字段名 | 英文名 | 数据类型 | 说明 | 计算公式 |
|--------|--------|----------|------|----------|
| Lead Time (天) | LT(d) | Number | 工序实际Lead Time | 见计算方法章节 |
| Process Time (天) | PT(d) | Number | 工序实际加工时间 | 见计算方法章节 |
| 标准时间 (天) | ST(d) | Number | 理论标准加工时间（天，不考虑周末） | 见计算方法章节 |
| 应完工时间 | DueTime | DateTime | 基于计划计算的应完工时间（考虑周末） | 见计算方法章节 |
| 周末扣除天数 | Weekend(d) | Number | TrackIn到应完工之间剔除的周末天数（单位：天） | 算法自动计算 |
| 完工状态 | CompletionStatus | Text | 是否按期完工（不含容差） | OnTime / Overdue |
| 容差小时数 | Tolerance(h) | Number | 固定容差时间（8小时） | 固定值 8.0 |
| 设备编号（数字） | Machine(#) | Number | 从machine字段提取的数字部分 | 从machine字段提取 |

---

### 6. 工序名称标准化

系统会自动将原始工序名称标准化为以下标准工序：

| 原始工序 | 标准工序 |
|----------|----------|
| CNC Milling, 铣削 | 数控铣 |
| CNC Turning, 车削 | 数控车 |
| WEDM, Wire EDM | 线切割 |
| Sawing | 锯 |
| Chrome Plating | 镀铬 |
| Slicing | 纵切 |
| TIG Welding | 氩弧焊 |
| Marking | 打标 |
| Deep Hole Drilling | 深孔钻 |
| Laser Welding | 激光焊 |
| Benchwork | 钳工 |
| Turning | 车削 |
| Assembly | 装配 |
| Vacuum Heat Treatment | 真空热处理 |
| Heat Treatment | 热处理 |

!!! tip "标准化好处"
    统一的工序名称便于跨数据源分析和报表展示

---

### 7. 数据质量说明

#### 7.1 必填字段

以下字段不能为空：
- BatchNumber（批次号）
- CFN（产品号）
- Operation（工序号）
- TrackOutTime（报工时间）

#### 7.2 空值处理

| 字段 | 空值处理方式 |
|------|-------------|
| Checkin_SFC | 空值时使用 EnterStepTime 或 TrackInTime |
| OEE | 空值或 0 时使用默认值 0.77 |
| Setup Time (h) | 空值时按 0 处理 |
| PreviousBatchEndTime | 第一批次为空 |

#### 7.3 数据类型约束

- **时间字段**：必须为有效的日期时间格式
- **数量字段**：必须为非负整数
- **OEE**：必须在 0-1 之间
- **Setup Time**：必须为非负数

</details>

<details class="abstract">
<summary><strong>🗄️ 数据源说明</strong></summary>

### 1. 数据源概览

SA 指标基于三大核心数据源：

<pre class="mermaid"><code>graph TB
    A[SharePoint 70-SFC文件夹&lt;br/&gt;LC-*.xlsx] --&gt;|ETL处理| B[SFC处理后数据&lt;br/&gt;SFC_处理后数据_latest.parquet]
    C[SharePoint 30-MES文件夹&lt;br/&gt;Product Output*.xlsx] --&gt;|ETL处理| D[MES处理后数据&lt;br/&gt;MES_处理后数据_latest.parquet]
    E[SharePoint 30-MES文件夹&lt;br/&gt;Routing + 机加工清单] --&gt;|ETL合并| F[标准时间表&lt;br/&gt;SAP_Routing_yyyymmdd.parquet]

    B --&gt; G[Power BI 报表]
    D --&gt; G
    F --&gt; G

    style A fill:#e1f5ff
    style C fill:#e1f5ff
    style E fill:#e1f5ff
    style B fill:#fff4e6
    style D fill:#fff4e6
    style F fill:#fff4e6
    style G fill:#e8f5e9</code></pre>

---

### 2. 核心数据源详细说明

#### 2.1 SFC 批次报工记录

| 项目 | 说明 |
|------|------|
| **Power Query 文件** | `e4_批次报工记录_SFC.pq` |
| **原始数据位置** | SharePoint `70-SFC` 文件夹 |
| **原始文件格式** | `LC-yyyymmddhhmmss.csv` 或 Excel |
| **处理后文件** | `SFC_处理后数据_latest.parquet` |
| **处理后位置** | SharePoint `30-MES导出数据/publish` 文件夹 |
| **ETL 脚本** | `etl_sfc.py` |
| **更新频率** | 手动触发 ETL 脚本 |

##### 主要字段

- 批次号（BatchNumber）
- 产品号（CFN）
- 工序号（Operation）
- **Check In 时间**（Checkin_SFC）⭐
- 报工时间（TrackOutTime）
- 产出数量（TrackOutQuantity）
- 报废数量（ScrapQuantity）
- Check In 人员、报工人员

##### 主要用途

!!! success "SFC 数据用途"
    - 提供 **Check In 时间**（Checkin_SFC）- PT 计算的关键字段
    - 补充 MES 数据的报工记录
    - 提供报废数量信息

---

#### 2.2 MES 批次报工记录

| 项目 | 说明 |
|------|------|
| **Power Query 文件** | `e2_批次报工记录_MES.pq` |
| **原始数据位置** | SharePoint `30-MES` 文件夹 |
| **原始文件格式** | `Product Output -CZM -FY26.xlsx` |
| **处理后文件** | `MES_处理后数据_latest.parquet` |
| **处理后位置** | SharePoint `30-MES导出数据/publish` 文件夹 |
| **ETL 脚本** | `etl_sa.py` |
| **更新频率** | 手动触发 ETL 脚本 |

##### 主要字段

- 批次号（BatchNumber）
- 产品号（CFN）
- 生产订单（ProductionOrder）
- 工序号（Operation）
- 工序名称（Operation description）
- 生产区域（ProductionArea）
- 工艺路线（Group）
- 机台号（machine）
- **进入工序时间**（EnterStepTime）
- **工序投入时间**（TrackInTime）
- **报工时间**（TrackOutTime）
- 投入数量（StepInQuantity）
- 产出数量（TrackOutQuantity）
- VSM、ERP代码、产品描述

##### 主要用途

!!! success "MES 数据用途"
    - **核心生产数据**，包含工序报工、时间记录、数量信息
    - 所有 SA 计算字段已在 ETL 中完成（LT、PT、ST、DueTime、CompletionStatus）
    - Power BI 中直接读取，无需二次计算

---

#### 2.3 产品标准时间表

| 项目 | 说明 |
|------|------|
| **Power Query 文件** | `e3_产品标准时间.pq` |
| **原始数据位置** | SharePoint `30-MES` 文件夹 |
| **原始文件** | `1303 Routing及机加工产品清单.xlsx` |
| **处理后文件** | `SAP_Routing_yyyymmdd.parquet` |
| **处理后位置** | SharePoint `30-MES导出数据/publish` 文件夹 |
| **ETL 脚本** | `convert_standard_time.py` |
| **更新频率** | SAP 标准时间更新时 |

##### 主要字段

- 产品号（CFN）
- 工序号（Operation）
- **单件机器时间**（EH_machine(s)）- 秒
- **单件人工时间**（EH_labor(s)）- 秒
- **设备综合效率**（OEE）- 0-1 之间
- **调试时间**（Setup Time (h)）- 小时

##### 主要用途

!!! success "标准时间表用途"
    - 提供 **标准时间计算参数**（机器时间、人工时间、OEE、调试时间）
    - 用于计算 **ST(d)**（标准时间）和 **DueTime**（应完工时间）

---

### 3. 辅助数据源

#### 3.1 工作日日历表

| 项目 | 说明 |
|------|------|
| **文件名** | `日历工作日表.csv` |
| **生成脚本** | `generate_calendar.py` |
| **存储位置** | ETL 脚本同级目录 |
| **更新频率** | 年度更新 |

##### 字段说明

| 字段名 | 数据类型 | 说明 | 示例 |
|--------|----------|------|------|
| 日期 | Date | 日期 | 2025-01-01 |
| 星期几 | Text | 周几 | 星期三 |
| 是否工作日 | Boolean | True/False | False |
| 节假日名称 | Text | 节假日名称 | 元旦 |

##### 主要用途

!!! success "日历表用途"
    - **DueTime 计算**：跳过非工作日（周末和法定节假日）
    - **Weekend(d) 计算**：统计非工作日天数

---

### 4. 数据存储格式

#### 4.1 为什么使用 Parquet 格式？

本项目采用 **Parquet 格式**替代传统的 Excel/CSV 格式，实现了显著的性能提升。

##### 性能对比（实测数据）

| 数据量 | Excel/CSV 读取时间 | Parquet 读取时间 | **性能提升** | 文件大小对比 |
|--------|------------------|-----------------|------------|-------------|
| 10万行 | ~30秒 | ~3秒 | **🚀 提升 90%** | CSV: 50MB / Parquet: 5-8MB (**减少 84-90%**) |
| 50万行 | ~2分钟 | ~8秒 | **🚀 提升 93%** | CSV: 250MB / Parquet: 25-40MB (**减少 84-90%**) |
| 100万行 | ~5分钟 | ~15秒 | **🚀 提升 95%** | CSV: 500MB / Parquet: 50-80MB (**减少 84-90%**) |

##### 格式特性对比

| 特性 | Parquet ⭐⭐⭐⭐⭐ | CSV ⭐⭐⭐ | Excel ⭐⭐ |
|------|-----------------|---------|----------|
| **文件大小** | 小（压缩率70-90%） | 大 | 很大 |
| **读取速度** | 极快（10-100倍于CSV） | 慢 | 最慢 |
| **数据类型保留** | ✅ 精确保留 | ❌ 全部文本 | ⚠️ 部分保留 |
| **Power BI 支持** | ✅ 原生支持 | ✅ 支持但慢 | ✅ 支持但很慢 |
| **增量刷新** | ✅ 适合 | ❌ 不适合 | ❌ 不适合 |
| **人工查看** | ❌ 需工具 | ✅ Excel可打开 | ✅ Excel可打开 |

!!! success "Parquet 格式核心优势"
    - ✅ **读取速度提升 90-95%**：列式存储，Power BI 加载速度提升 **5-10 倍**
    - ✅ **文件大小减少 84-90%**：高压缩率，节省存储空间和上传时间
    - ✅ **数据类型精确保留**：自动保留日期、数字、文本等类型，无需重新转换
    - ✅ **Power BI 原生支持**：无需额外配置，直接读取
    - ✅ **适合大数据场景**：处理百万级数据性能优秀

---

### 5. 数据更新流程

#### 5.1 日常更新流程

<pre class="mermaid"><code>graph TD
    A[1. 下载最新 MES Excel] --&gt; B[2. 上传到 SharePoint 30-MES 文件夹]
    B --&gt; C[3. 运行 etl_sa.py]
    C --&gt; D[4. 生成 MES Parquet 文件]
    D --&gt; E[5. 上传到 SharePoint publish 文件夹]
    E --&gt; F[6. Power BI 刷新数据]</code></pre>

#### 5.2 SFC 数据更新流程

<pre class="mermaid"><code>graph TD
    A[1. 下载最新 SFC 文件] --&gt; B[2. 上传到 SharePoint 70-SFC 文件夹]
    B --&gt; C[3. 运行 etl_sfc.py]
    C --&gt; D[4. 生成 SFC Parquet 文件]
    D --&gt; E[5. 运行 etl_sa.py 重新处理 MES]
    E --&gt; F[6. Power BI 刷新数据]</code></pre>

#### 5.3 标准时间更新流程

<pre class="mermaid"><code>graph TD
    A[1. SAP 导出最新 Routing] --&gt; B[2. 更新机加工清单 Excel]
    B --&gt; C[3. 上传到 SharePoint 30-MES 文件夹]
    C --&gt; D[4. 运行 convert_standard_time.py]
    D --&gt; E[5. 生成 SAP_Routing Parquet]
    E --&gt; F[6. 运行 etl_sa.py 重新处理 MES]
    F --&gt; G[7. Power BI 刷新数据]</code></pre>

---

### 6. 数据质量监控

#### 6.1 ETL 日志

每次 ETL 运行会生成日志文件：

<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>logs/
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>├── etl_sa.log          # MES 处理日志
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>├── etl_sfc.log         # SFC 处理日志
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>└── manifest.csv        # 处理记录清单
</span></code></pre></div>

#### 6.2 数据质量检查

ETL 脚本会自动检查：

- ✅ 必填字段完整性
- ✅ 数据类型正确性
- ✅ 时间逻辑合理性
- ✅ 数量非负性
- ✅ OEE 范围（0-1）

</details>

<details class="abstract">
<summary><strong>🧮 计算示例</strong></summary>

### 示例 1：标准批次计算（按期完成）

#### 1.1 基础数据

假设有一个批次的基本信息如下：

| 字段 | 值 |
|------|------|
| BatchNumber | K24A2066 |
| CFN | 858-957-11 |
| Operation | 0020 |
| Operation description | 数控铣 |
| machine | M001 |
| EnterStepTime | 2025-01-10 08:00:00 |
| TrackInTime | 2025-01-10 09:00:00 |
| TrackOutTime | 2025-01-12 16:00:00 |
| StepInQuantity | 100 |

#### 1.2 标准时间参数（来自 Routing 表）

| 参数 | 值 |
|------|------|
| EH_machine(s) | 3600（秒） |
| EH_labor(s) | 1800（秒） |
| OEE | 0.80 |
| Setup Time (h) | 0.5 |
| Setup | Yes |

#### 1.3 计算过程

##### Step 1: 计算 Lead Time (LT)

<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># 非 0010 工序，使用 EnterStepTime</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="n">LT</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">TrackOutTime</span> <span class="o">-</span> <span class="n">EnterStepTime</span><span class="p">)</span> <span class="o">/</span> <span class="mi">24</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>      <span class="o">=</span> <span class="p">(</span><span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">16</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">-</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span> <span class="mi">08</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">)</span> <span class="o">/</span> <span class="mi">24</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>      <span class="o">=</span> <span class="mi">56</span> <span class="n">小时</span> <span class="o">/</span> <span class="mi">24</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>      <span class="o">=</span> <span class="mf">2.33</span> <span class="n">天</span>
</span></code></pre></div>

##### Step 2: 计算 Process Time (PT)

<div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># 假设没有 Checkin_SFC，使用 TrackInTime</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="n">PT</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">TrackOutTime</span> <span class="o">-</span> <span class="n">TrackInTime</span><span class="p">)</span> <span class="o">/</span> <span class="mi">24</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>      <span class="o">=</span> <span class="p">(</span><span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">16</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">-</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span> <span class="mi">09</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">)</span> <span class="o">/</span> <span class="mi">24</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>      <span class="o">=</span> <span class="mi">55</span> <span class="n">小时</span> <span class="o">/</span> <span class="mi">24</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>      <span class="o">=</span> <span class="mf">2.29</span> <span class="n">天</span>
</span></code></pre></div>

##### Step 3: 计算标准时间 (ST)

<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># 1. 单件时间</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="n">单件时间_秒</span> <span class="o">=</span> <span class="n">EH_machine</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3600</span> <span class="n">秒</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="n">单件时间_小时</span> <span class="o">=</span> <span class="mi">3600</span> <span class="o">/</span> <span class="mi">3600</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="n">小时</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="c1"># 2. OEE</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="n">OEE</span> <span class="o">=</span> <span class="mf">0.80</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="c1"># 3. 调试时间</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="n">Setup</span> <span class="o">=</span> <span class="s2">&quot;Yes&quot;</span> <span class="err">→</span> <span class="n">调试时间</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="n">小时</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="c1"># 4. 计算 ST</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="n">ST_小时</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="p">(</span><span class="mi">100</span> <span class="err">×</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">0.80</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>        <span class="o">=</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mi">125</span> <span class="o">+</span> <span class="mf">0.5</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>        <span class="o">=</span> <span class="mi">126</span> <span class="n">小时</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="n">ST</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="mi">126</span> <span class="o">/</span> <span class="mi">24</span> <span class="o">=</span> <span class="mf">5.25</span> <span class="n">天</span>
</span></code></pre></div>

##### Step 4: 计算应完工时间 (DueTime)

假设工作日日历如下：

| 日期 | 是否工作日 |
|------|------------|
| 2025-01-10（五） | True |
| 2025-01-11（六） | False |
| 2025-01-12（日） | False |
| 2025-01-13（一） | True |
| 2025-01-14（二） | True |
| 2025-01-15（三） | True |

<div class="language-python highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># 计划小时数 = 126 小时</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="c1"># 开始时间 = TrackInTime = 2025-01-10 09:00:00</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="n">累加过程</span><span class="err">（</span><span class="mi">24</span><span class="n">小时连续工作制</span><span class="err">）：</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="o">-</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span><span class="err">：</span><span class="n">工作日</span><span class="err">，</span><span class="n">累加</span> <span class="mi">24</span><span class="n">h</span><span class="err">（</span><span class="n">剩余</span> <span class="mi">126</span><span class="o">-</span><span class="mi">24</span><span class="o">=</span><span class="mi">102</span><span class="n">h</span><span class="err">）</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="o">-</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">11</span><span class="err">：</span><span class="n">周末</span><span class="err">，</span><span class="n">跳过</span><span class="err">（</span><span class="n">剩余</span> <span class="mi">102</span><span class="n">h</span><span class="err">，</span><span class="n">weekend_hours</span><span class="o">+</span><span class="mi">24</span><span class="err">）</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="o">-</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span><span class="err">：</span><span class="n">周末</span><span class="err">，</span><span class="n">跳过</span><span class="err">（</span><span class="n">剩余</span> <span class="mi">102</span><span class="n">h</span><span class="err">，</span><span class="n">weekend_hours</span><span class="o">+</span><span class="mi">48</span><span class="err">）</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="o">-</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">13</span><span class="err">：</span><span class="n">工作日</span><span class="err">，</span><span class="n">累加</span> <span class="mi">24</span><span class="n">h</span><span class="err">（</span><span class="n">剩余</span> <span class="mi">102</span><span class="o">-</span><span class="mi">24</span><span class="o">=</span><span class="mi">78</span><span class="n">h</span><span class="err">）</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="o">-</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">14</span><span class="err">：</span><span class="n">工作日</span><span class="err">，</span><span class="n">累加</span> <span class="mi">24</span><span class="n">h</span><span class="err">（</span><span class="n">剩余</span> <span class="mi">78</span><span class="o">-</span><span class="mi">24</span><span class="o">=</span><span class="mi">54</span><span class="n">h</span><span class="err">）</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="o">-</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">15</span><span class="err">：</span><span class="n">工作日</span><span class="err">，</span><span class="n">累加</span> <span class="mi">24</span><span class="n">h</span><span class="err">（</span><span class="n">剩余</span> <span class="mi">54</span><span class="o">-</span><span class="mi">24</span><span class="o">=</span><span class="mi">30</span><span class="n">h</span><span class="err">）</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="o">-</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">16</span><span class="err">：</span><span class="n">工作日</span><span class="err">，</span><span class="n">累加</span> <span class="mi">24</span><span class="n">h</span><span class="err">（</span><span class="n">剩余</span> <span class="mi">30</span><span class="o">-</span><span class="mi">24</span><span class="o">=</span><span class="mi">6</span><span class="n">h</span><span class="err">）</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="o">-</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">17</span><span class="err">：</span><span class="n">工作日</span><span class="err">，</span><span class="n">累加</span> <span class="mi">6</span><span class="n">h</span><span class="err">（</span><span class="n">剩余</span> <span class="mi">0</span><span class="n">h</span><span class="err">）</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="n">最终</span><span class="err">：</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="n">DueTime</span> <span class="o">=</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">17</span> <span class="mi">15</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="err">（</span><span class="n">约</span><span class="err">）</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="n">Weekend</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="mi">48</span> <span class="n">小时</span> <span class="o">/</span> <span class="mi">24</span> <span class="o">=</span> <span class="mf">2.00</span> <span class="n">天</span>
</span></code></pre></div>

##### Step 5: 判断完工状态

<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">TrackOutTime</span> <span class="o">=</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span> <span class="mi">16</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="n">DueTime</span> <span class="o">=</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">26</span> <span class="mi">17</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="n">TrackOutTime</span> <span class="o">&lt;=</span> <span class="n">DueTime</span> <span class="err">→</span> <span class="n">CompletionStatus</span> <span class="o">=</span> <span class="s2">&quot;OnTime&quot;</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="n">SA状态</span> <span class="o">=</span> <span class="mi">1</span>
</span></code></pre></div>

#### 1.4 最终结果

| 计算字段 | 结果 |
|----------|------|
| LT(d) | 2.33 天 |
| PT(d) | 2.29 天 |
| ST(d) | 5.25 天 |
| DueTime | 2025-01-26 17:00:00 |
| Weekend(d) | 1.33 天 |
| CompletionStatus | OnTime |
| SA状态 | 1 |

!!! success "结论"
    该批次提前完成，SA 状态为 **按期（OnTime）**

---

### 示例 2：逾期批次计算

#### 2.1 基础数据

| 字段 | 值 |
|------|------|
| BatchNumber | K24B3088 |
| CFN | 858-957-11 |
| Operation | 0030 |
| Operation description | 线切割 |
| TrackInTime | 2025-01-15 08:00:00 |
| TrackOutTime | 2025-01-25 18:00:00 |
| StepInQuantity | 50 |

#### 2.2 标准时间参数

| 参数 | 值 |
|------|------|
| EH_machine(s) | 7200（秒） |
| OEE | 0.75 |
| Setup Time (h) | 1.0 |
| Setup | Yes |

#### 2.3 计算过程

##### 计算 ST

<div class="language-python highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">单件时间_小时</span> <span class="o">=</span> <span class="mi">7200</span> <span class="o">/</span> <span class="mi">3600</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="n">小时</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="n">ST_小时</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="mi">50</span> <span class="err">×</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">0.75</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>        <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">133.33</span> <span class="o">+</span> <span class="mf">0.5</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>        <span class="o">=</span> <span class="mf">134.83</span> <span class="n">小时</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="n">ST</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="mf">134.83</span> <span class="o">/</span> <span class="mi">24</span> <span class="o">=</span> <span class="mf">5.62</span> <span class="n">天</span>
</span></code></pre></div>

##### 计算 DueTime（假设无周末）

<div class="language-python highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1"># 简化计算：5.62 天 ≈ 6 个工作日</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="n">DueTime</span> <span class="err">≈</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">23</span> <span class="mi">12</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
</span></code></pre></div>

##### 判断完工状态

<div class="language-python highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">TrackOutTime</span> <span class="o">=</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">25</span> <span class="mi">18</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="n">DueTime</span> <span class="o">=</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">23</span> <span class="mi">12</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="n">TrackOutTime</span> <span class="o">&gt;</span> <span class="n">DueTime</span> <span class="err">→</span> <span class="n">CompletionStatus</span> <span class="o">=</span> <span class="s2">&quot;Overdue&quot;</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="n">SA状态</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="n">逾期时间</span> <span class="o">=</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">25</span> <span class="mi">18</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">-</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">23</span> <span class="mi">12</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">=</span> <span class="mf">2.25</span> <span class="n">天</span>
</span></code></pre></div>

#### 2.4 最终结果

| 计算字段 | 结果 |
|----------|------|
| ST(d) | 5.62 天 |
| DueTime | 2025-01-23 12:00:00 |
| TrackOutTime | 2025-01-25 18:00:00 |
| CompletionStatus | Overdue |
| SA状态 | 0 |
| 逾期时间 | 2.25 天 |

!!! warning "结论"
    该批次逾期 2.25 天，SA 状态为 **逾期（Overdue）**

---

### 示例 3：0010 工序特殊处理

#### 3.1 基础数据

| 字段 | 值 |
|------|------|
| BatchNumber | K25A1001 |
| Operation | 0010 |
| EnterStepTime | 2025-01-20 10:00:00 |
| TrackInTime | 2025-01-20 11:00:00 |
| Checkin_SFC | 2025-01-20 09:30:00 |
| TrackOutTime | 2025-01-21 15:00:00 |

#### 3.2 计算 LT（0010 工序特殊逻辑）

<div class="language-python highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1"># 0010 工序优先级：Checkin_SFC &gt; EnterStepTime &gt; TrackInTime</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="n">开始时间</span> <span class="o">=</span> <span class="n">Checkin_SFC</span> <span class="o">=</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="n">LT</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">21</span> <span class="mi">15</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">-</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="p">)</span> <span class="o">/</span> <span class="mi">24</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>      <span class="o">=</span> <span class="mf">29.5</span> <span class="n">小时</span> <span class="o">/</span> <span class="mi">24</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>      <span class="o">=</span> <span class="mf">1.23</span> <span class="n">天</span>
</span></code></pre></div>

#### 3.3 计算 PT

<div class="language-python highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># PT 优先使用 Checkin_SFC</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="n">开始时间</span> <span class="o">=</span> <span class="n">Checkin_SFC</span> <span class="o">=</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="n">PT</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">21</span> <span class="mi">15</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">-</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="p">)</span> <span class="o">/</span> <span class="mi">24</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>      <span class="o">=</span> <span class="mf">1.23</span> <span class="n">天</span>
</span></code></pre></div>

!!! info "0010 工序说明"
    0010 工序（首道工序）会优先使用 **Checkin_SFC** 作为起始时间，因为这是批次正式进入生产的时间点。

---

### 示例 4：多批次 SA 达成率计算

#### 4.1 数据集

假设某周有以下批次：

| BatchNumber | Operation | CompletionStatus | SA状态 |
|-------------|-----------|------------------|--------|
| K24A2066 | 0020 | OnTime | 1 |
| K24B3088 | 0030 | Overdue | 0 |
| K24C1234 | 0010 | OnTime | 1 |
| K24D5678 | 0040 | OnTime | 1 |
| K24E9012 | 0020 | Overdue | 0 |
| K24F3456 | 0030 | OnTime | 1 |

#### 4.2 计算 SA 达成率

<div class="language-python highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="n">总批次数</span> <span class="o">=</span> <span class="mi">6</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="n">按期批次数</span> <span class="o">=</span> <span class="mi">4</span><span class="err">（</span><span class="n">SA状态</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">的数量</span><span class="err">）</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="n">SA达成率</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">6</span> <span class="err">×</span> <span class="mi">100</span><span class="o">%</span> <span class="o">=</span> <span class="mf">66.67</span><span class="o">%</span>
</span></code></pre></div>

#### 4.3 分工序分析

| 工序 | 总批次 | 按期批次 | SA达成率 |
|------|--------|----------|----------|
| 0010 | 1 | 1 | 100.00% |
| 0020 | 2 | 1 | 50.00% |
| 0030 | 2 | 1 | 50.00% |
| 0040 | 1 | 1 | 100.00% |

!!! tip "分析建议"
    - 整体 SA 达成率：66.67%
    - 0010、0040 工序表现优秀（100%）
    - 0020、0030 工序需要关注和改进

---

### 示例 5：容差分析

#### 5.1 数据

| BatchNumber | TrackOutTime | DueTime | 差异（小时） |
|-------------|--------------|---------|-------------|
| K24A1111 | 2025-01-15 16:00 | 2025-01-15 17:00 | -1（提前） |
| K24A2222 | 2025-01-15 20:00 | 2025-01-15 17:00 | +3（逾期） |
| K24A3333 | 2025-01-16 01:00 | 2025-01-15 17:00 | +8（逾期） |
| K24A4444 | 2025-01-16 02:00 | 2025-01-15 17:00 | +9（逾期） |

#### 5.2 不含容差（标准）

<div class="language-python highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="n">容差</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">小时</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="n">K24A1111</span><span class="p">:</span> <span class="n">OnTime</span><span class="err">（</span><span class="o">-</span><span class="mi">1</span><span class="n">h</span> <span class="err">≤</span> <span class="mi">0</span><span class="err">）</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="n">K24A2222</span><span class="p">:</span> <span class="n">Overdue</span><span class="err">（</span><span class="o">+</span><span class="mi">3</span><span class="n">h</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="err">）</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="n">K24A3333</span><span class="p">:</span> <span class="n">Overdue</span><span class="err">（</span><span class="o">+</span><span class="mi">8</span><span class="n">h</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="err">）</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="n">K24A4444</span><span class="p">:</span> <span class="n">Overdue</span><span class="err">（</span><span class="o">+</span><span class="mi">9</span><span class="n">h</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="err">）</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="n">SA达成率</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">4</span> <span class="o">=</span> <span class="mi">25</span><span class="o">%</span>
</span></code></pre></div>

#### 5.3 含 8 小时容差

<div class="language-python highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="n">容差</span> <span class="o">=</span> <span class="mi">8</span> <span class="n">小时</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="n">K24A1111</span><span class="p">:</span> <span class="n">OnTime</span><span class="err">（</span><span class="o">-</span><span class="mi">1</span><span class="n">h</span> <span class="err">≤</span> <span class="mi">8</span><span class="n">h</span><span class="err">）</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="n">K24A2222</span><span class="p">:</span> <span class="n">OnTime</span><span class="err">（</span><span class="o">+</span><span class="mi">3</span><span class="n">h</span> <span class="err">≤</span> <span class="mi">8</span><span class="n">h</span><span class="err">）</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="n">K24A3333</span><span class="p">:</span> <span class="n">OnTime</span><span class="err">（</span><span class="o">+</span><span class="mi">8</span><span class="n">h</span> <span class="err">≤</span> <span class="mi">8</span><span class="n">h</span><span class="err">）</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="n">K24A4444</span><span class="p">:</span> <span class="n">Overdue</span><span class="err">（</span><span class="o">+</span><span class="mi">9</span><span class="n">h</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="n">h</span><span class="err">）</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="n">SA达成率</span> <span class="o">=</span> <span class="mi">3</span><span class="o">/</span><span class="mi">4</span> <span class="o">=</span> <span class="mi">75</span><span class="o">%</span>
</span></code></pre></div>

!!! info "容差说明"
    - 标准 SA 计算不包含容差
    - 如需容差分析，可在 Power BI 中创建计算列
    - 常用容差：8 小时（1 个工作日）

---

## Power BI DAX 示例

### 计算 SA 达成率

<div class="language-dax highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>SA达成率 = 
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="nf">DIVIDE</span><span class="p">(</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="w">    </span><span class="nf">COUNTROWS</span><span class="p">(</span><span class="nf">FILTER</span><span class="p">(</span><span class="na">&#39;MES数据&#39;</span><span class="p">,</span><span class="w"> </span><span class="na">&#39;MES数据&#39;[CompletionStatus]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;OnTime&quot;</span><span class="p">)),</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">    </span><span class="nf">COUNTROWS</span><span class="p">(</span><span class="na">&#39;MES数据&#39;</span><span class="p">),</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="w">    </span><span class="m">0</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="p">)</span>
</span></code></pre></div>

### 计算逾期批次数

<div class="language-dax highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>逾期批次数 = 
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="nf">COUNTROWS</span><span class="p">(</span><span class="nf">FILTER</span><span class="p">(</span><span class="na">&#39;MES数据&#39;</span><span class="p">,</span><span class="w"> </span><span class="na">&#39;MES数据&#39;[CompletionStatus]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Overdue&quot;</span><span class="p">))</span>
</span></code></pre></div>

### 计算平均逾期时间（仅逾期批次）

<div class="language-dax highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>平均逾期时间_天 = 
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="nf">AVERAGEX</span><span class="p">(</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="w">    </span><span class="nf">FILTER</span><span class="p">(</span><span class="na">&#39;MES数据&#39;</span><span class="p">,</span><span class="w"> </span><span class="na">&#39;MES数据&#39;[CompletionStatus]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Overdue&quot;</span><span class="p">),</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="w">    </span><span class="p">(</span><span class="na">&#39;MES数据&#39;[TrackOutTime]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="na">&#39;MES数据&#39;[DueTime]</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="p">)</span>
</span></code></pre></div>

</details>

<hr />
<h2 id="_8">关键字段速查<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>字段名</th>
<th>说明</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>BatchNumber</strong></td>
<td>批次号</td>
<td>唯一标识一个生产批次</td>
</tr>
<tr>
<td><strong>Operation</strong></td>
<td>工序号</td>
<td>标识具体工序</td>
</tr>
<tr>
<td><strong>TrackOutTime</strong></td>
<td>报工时间</td>
<td>实际完工时间</td>
</tr>
<tr>
<td><strong>DueTime</strong></td>
<td>应完工时间</td>
<td>计划完工时间</td>
</tr>
<tr>
<td><strong>ST(d)</strong></td>
<td>标准时间</td>
<td>理论加工时间</td>
</tr>
<tr>
<td><strong>CompletionStatus</strong></td>
<td>完工状态</td>
<td>OnTime/Overdue</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_9">重要说明<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<div class="admonition warning">
<p class="admonition-title">数据处理注意事项</p>
<ul>
<li>SA 指标已在 ETL 阶段完成所有计算</li>
<li>Power BI 中直接读取 Parquet 文件，无需二次计算</li>
<li>建议使用增量刷新优化 Power BI 性能</li>
</ul>
</div>
<div class="admonition tip">
<p class="admonition-title">最佳实践</p>
<ul>
<li>定期更新标准时间表（SAP Routing）</li>
<li>关注逾期批次的原因分析</li>
<li>结合 OEE、Setup Time 优化生产计划</li>
</ul>
</div>
<hr />
<h2 id="_10">相关资源<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="../../etl/etl-sa/">ETL 处理流程</a></li>
<li><a href="../../pq/mes-records/">Power Query 代码</a></li>
<li><a href="../../guide/faq/">常见问题</a></li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../supply-chain/" class="btn btn-neutral float-left" title="供应链 KPI 总览"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../inventory-turns/" class="btn btn-neutral float-right" title="IT - 库存周转率">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../supply-chain/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../inventory-turns/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      <script src="../../javascripts/mathjax.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
